# Анализ состояния прокси - 2025-12-10

## Обнаруженная проблема

**16 зависших прокси** - прокси помечены как "используются" (`is_in_use=true`), но их `worker_id` не существуют в активных задачах.

### Детали проблемы

- **Container 8b4f59aa**: 15 зависших прокси (контейнер упал ~1 час назад)
- **Container b77514be**: 1 зависший прокси

## Причины

1. **Контейнеры упали/перезапустились** без корректного освобождения ресурсов
2. **Heartbeat механизм освобождает задачи, но НЕ прокси**
   - `heartbeat_manager.py` возвращает `catalog_tasks`/`object_tasks` в `pending`
   - Но не обновляет таблицу `proxies`
3. **Отсутствие cleanup при старте контейнера**
   - При перезапуске контейнер не освобождает свои старые прокси

## Выполненные действия

```sql
-- Освобождено 16 зависших прокси
UPDATE proxies SET is_in_use = false, worker_id = NULL WHERE worker_id LIKE '8b4f59aa_%';
UPDATE proxies SET is_in_use = false, worker_id = NULL WHERE worker_id LIKE 'b77514be_%' 
AND worker_id NOT IN (SELECT worker_id FROM catalog_tasks WHERE status = 'processing');
```

### Результат
- **До**: 13 свободных прокси
- **После**: 29 свободных прокси
- Система восстановлена

## Рекомендации по улучшению

### 1. КРИТИЧНО: Cleanup при старте контейнера

**Файл**: `container/main.py`

Добавить перед запуском воркеров:

```python
async def cleanup_container_proxies(container_id: str):
    """Освобождает все прокси текущего контейнера при старте"""
    conn = await asyncpg.connect(...)
    result = await conn.execute('''
        UPDATE proxies
        SET is_in_use = false, worker_id = NULL
        WHERE worker_id LIKE $1
    ''', f'{container_id}_%')
    logger.info(f"Freed stuck proxies for container {container_id}: {result}")
    await conn.close()

# В main():
container_id = generate_container_id()
await cleanup_container_proxies(container_id)
```

### 2. КРИТИЧНО: Освобождение прокси в heartbeat

**Файл**: `container/heartbeat_manager.py`

При возврате задачи в `pending` освобождать прокси:

```python
async def check_heartbeats():
    while True:
        # ... существующий код ...
        
        # При возврате задачи также освободить прокси
        if expired_tasks:
            for task in expired_tasks:
                worker_id = task['worker_id']
                
                # Вернуть задачу в pending
                await return_task_to_pending(task)
                
                # Освободить прокси воркера
                await conn.execute('''
                    UPDATE proxies
                    SET is_in_use = false, worker_id = NULL
                    WHERE worker_id = $1
                ''', worker_id)
                
                logger.warning(f"Freed proxy for expired worker {worker_id}")
```

### 3. ЖЕЛАТЕЛЬНО: Периодическая проверка зависших прокси

**Файл**: `container/heartbeat_manager.py`

Добавить фоновую задачу:

```python
async def check_stuck_proxies():
    """Периодически проверяет и освобождает зависшие прокси"""
    conn = await asyncpg.connect(...)
    
    while True:
        try:
            result = await conn.execute('''
                UPDATE proxies 
                SET is_in_use = false, worker_id = NULL
                WHERE is_in_use = true
                AND worker_id NOT IN (
                    SELECT COALESCE(worker_id, '') FROM catalog_tasks WHERE status = 'processing'
                    UNION
                    SELECT COALESCE(worker_id, '') FROM object_tasks WHERE status = 'processing'
                )
            ''')
            
            if result != 'UPDATE 0':
                logger.warning(f"Freed stuck proxies: {result}")
                
        except Exception as e:
            logger.error(f"Error checking stuck proxies: {e}")
        
        await asyncio.sleep(300)  # Каждые 5 минут

# В main() запустить:
asyncio.create_task(check_stuck_proxies())
```

### 4. ОПЦИОНАЛЬНО: Graceful shutdown

**Файл**: `container/browser_worker.py`

```python
import signal

class BrowserWorker:
    def __init__(self):
        self.current_proxy_id = None
        self.should_stop = False
        
        # Обработка сигналов
        signal.signal(signal.SIGTERM, self.handle_shutdown)
        signal.signal(signal.SIGINT, self.handle_shutdown)
    
    def handle_shutdown(self, signum, frame):
        self.should_stop = True
    
    async def cleanup(self):
        """Освобождение ресурсов при выходе"""
        if self.current_proxy_id:
            await self.release_proxy(self.current_proxy_id)
        if self.browser:
            await self.browser.close()
    
    async def run(self):
        try:
            while not self.should_stop:
                # ... работа воркера ...
                pass
        finally:
            await self.cleanup()
```

## Статистика после исправления

```
Всего прокси:       100
В использовании:    44  (3 активных контейнера)
Заблокировано:      27
Свободно:           29

Активные контейнеры:
  - Container b77514be: 15 задач
  - Container 93816237: 15 задач
  - Container e1bf8c63: 13 задач
```

## Приоритет реализации

1. **Сегодня**: Cleanup при старте контейнера (main.py)
2. **Сегодня**: Освобождение прокси в heartbeat (heartbeat_manager.py)
3. **На этой неделе**: Периодическая проверка зависших прокси
4. **Опционально**: Graceful shutdown

---

**Дата анализа**: 2025-12-10  
**Статус**: Проблема решена, рекомендации подготовлены
