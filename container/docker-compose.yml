
services:
  # Локальный postgres закомментирован, используется внешняя БД (DB_HOST: 81.30.105.134:5419)
  # postgres:
  #   image: postgres:16
  #   container_name: avito_postgres
  #   environment:
  #     POSTGRES_DB: ${DB_NAME:-avito_parser}
  #     POSTGRES_USER: ${DB_USER:-parser}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-parser_password}
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "${DB_PORT:-5432}:5432"
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-parser}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped

  parser:
    build: .
    container_name: avito_parser
    # depends_on удален, так как используется внешняя БД
    environment:
      # База данных
      DB_HOST: ${DB_HOST:-81.30.105.134}
      DB_PORT: ${DB_PORT:-5419}
      DB_NAME: ${DB_NAME:-zamer_sys}
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-Password123}

      # Воркер
      TOTAL_BROWSER_WORKERS: ${TOTAL_BROWSER_WORKERS:-12}
      TOTAL_VALIDATION_WORKERS: ${TOTAL_VALIDATION_WORKERS:-12}
      CATALOG_BUFFER_SIZE: ${CATALOG_BUFFER_SIZE:-12}  # Минимум артикулов со спарсенными каталогами для переключения на объявления

      # Heartbeat
      HEARTBEAT_TIMEOUT_SECONDS: ${HEARTBEAT_TIMEOUT_SECONDS:-1800}
      HEARTBEAT_UPDATE_INTERVAL: ${HEARTBEAT_UPDATE_INTERVAL:-60}
      HEARTBEAT_CHECK_INTERVAL: ${HEARTBEAT_CHECK_INTERVAL:-120}

      # Парсинг каталогов
      CATALOG_MAX_PAGES: ${CATALOG_MAX_PAGES:-10}
      CATALOG_INCLUDE_HTML: ${CATALOG_INCLUDE_HTML:-false}

      # Парсинг объявлений
      OBJECT_INCLUDE_HTML: ${OBJECT_INCLUDE_HTML:-false}
      SKIP_OBJECT_PARSING: ${SKIP_OBJECT_PARSING:-True}  # Пропустить парсинг объявлений (только валидация)

      # Режим повторного парсинга
      REPARSE_MODE: ${REPARSE_MODE:-false}  # Режим повторного парсинга (только ранее спарсенные объявления)
      MIN_REPARSE_INTERVAL_HOURS: ${MIN_REPARSE_INTERVAL_HOURS:-24}  # Минимальный интервал между парсингами одного объявления

      # Валидация
      MIN_PRICE: ${MIN_PRICE:-8000.0}
      MIN_VALIDATED_ITEMS: ${MIN_VALIDATED_ITEMS:-5}
      MIN_SELLER_REVIEWS: ${MIN_SELLER_REVIEWS:-0}
      ENABLE_PRICE_VALIDATION: ${ENABLE_PRICE_VALIDATION:-true}
      REQUIRE_ARTICULUM_IN_TEXT: ${REQUIRE_ARTICULUM_IN_TEXT:-true}
      ENABLE_AI_VALIDATION: ${ENABLE_AI_VALIDATION:-false}

      # Xvfb
      XVFB_DISPLAY_START: ${XVFB_DISPLAY_START:-99}
      XVFB_RESOLUTION: ${XVFB_RESOLUTION:-1920x1080x24}

      # Прокси
      PROXY_WAIT_TIMEOUT: ${PROXY_WAIT_TIMEOUT:-10}
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    # Ограничение ресурсов (опционально)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4.0'
    #       memory: 8G
    #     reservations:
    #       cpus: '2.0'
    #       memory: 4G

# Volumes закомментированы, так как используется внешняя БД
# volumes:
#   postgres_data:
#     driver: local
