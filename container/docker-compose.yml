version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: avito_postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-avito_parser}
      POSTGRES_USER: ${DB_USER:-parser}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-parser_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-parser}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  parser:
    build: .
    container_name: avito_parser
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # База данных
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-avito_parser}
      DB_USER: ${DB_USER:-parser}
      DB_PASSWORD: ${DB_PASSWORD:-parser_password}

      # Воркеры
      TOTAL_BROWSER_WORKERS: ${TOTAL_BROWSER_WORKERS:-3}
      MAX_CATALOG_WORKERS: ${MAX_CATALOG_WORKERS:-3}
      MAX_OBJECT_WORKERS: ${MAX_OBJECT_WORKERS:-5}
      TOTAL_VALIDATION_WORKERS: ${TOTAL_VALIDATION_WORKERS:-5}

      # Heartbeat
      HEARTBEAT_TIMEOUT_SECONDS: ${HEARTBEAT_TIMEOUT_SECONDS:-1800}
      HEARTBEAT_UPDATE_INTERVAL: ${HEARTBEAT_UPDATE_INTERVAL:-60}
      HEARTBEAT_CHECK_INTERVAL: ${HEARTBEAT_CHECK_INTERVAL:-120}

      # Парсинг каталогов
      CATALOG_MAX_PAGES: ${CATALOG_MAX_PAGES:-10}
      CATALOG_INCLUDE_HTML: ${CATALOG_INCLUDE_HTML:-false}

      # Парсинг объявлений
      OBJECT_INCLUDE_HTML: ${OBJECT_INCLUDE_HTML:-false}
      SKIP_OBJECT_PARSING: ${SKIP_OBJECT_PARSING:-false}  # Пропустить парсинг объявлений (только валидация)

      # Режим повторного парсинга
      REPARSE_MODE: ${REPARSE_MODE:-false}  # Режим повторного парсинга (только ранее спарсенные объявления)
      MIN_REPARSE_INTERVAL_HOURS: ${MIN_REPARSE_INTERVAL_HOURS:-24}  # Минимальный интервал между парсингами одного объявления

      # Валидация
      MIN_PRICE: ${MIN_PRICE:-1000.0}
      MIN_VALIDATED_ITEMS: ${MIN_VALIDATED_ITEMS:-3}
      MIN_SELLER_REVIEWS: ${MIN_SELLER_REVIEWS:-0}
      ENABLE_AI_VALIDATION: ${ENABLE_AI_VALIDATION:-true}

      # Vertex AI (для ИИ-валидации)
      VERTEX_AI_PROJECT_ID: ${VERTEX_AI_PROJECT_ID:-gen-lang-client-0026618973}
      VERTEX_AI_LOCATION: ${VERTEX_AI_LOCATION:-us-central1}
      VERTEX_AI_MODEL: ${VERTEX_AI_MODEL:-google/gemini-2.5-flash}
      GOOGLE_APPLICATION_CREDENTIALS: /app/gen-lang-client-0026618973-4dbdd3b53fdc.json

      # Xvfb
      XVFB_DISPLAY_START: ${XVFB_DISPLAY_START:-99}
      XVFB_RESOLUTION: ${XVFB_RESOLUTION:-1920x1080x24}

      # Прокси
      PROXY_WAIT_TIMEOUT: ${PROXY_WAIT_TIMEOUT:-10}
    volumes:
      - ./logs:/app/logs
      - ./gen-lang-client-0026618973-4dbdd3b53fdc.json:/app/gen-lang-client-0026618973-4dbdd3b53fdc.json:ro
    restart: unless-stopped
    # Ограничение ресурсов (опционально)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4.0'
    #       memory: 8G
    #     reservations:
    #       cpus: '2.0'
    #       memory: 4G

volumes:
  postgres_data:
    driver: local
