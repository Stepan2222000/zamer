# Документация по скриптам системы Zamer

Это руководство описывает назначение каждого скрипта в папке `scripts/`, их роли в системе и рекомендации по использованию.

---

## Оглавление

1. [Основные файлы системы](#основные-файлы-системы)
2. [Скрипты загрузки данных](#скрипты-загрузки-данных)
3. [Миграции базы данных](#миграции-базы-данных)
4. [Аналитика и отчеты](#аналитика-и-отчеты)
5. [Администрирование и мониторинг](#администрирование-и-мониторинг)
6. [Экспорт данных](#экспорт-данных)
7. [Деплой](#деплой)
8. [Рекомендации по необходимости скриптов](#рекомендации-по-необходимости-скриптов)

---

## Основные файлы системы

### `schema.sql`
**Статус:** НЕОБХОДИМ

SQL-схема базы данных. Содержит определения всех таблиц системы:
- `articulums` — список артикулов для парсинга (состояния: NEW → CATALOG_PARSING → VALIDATED и т.д.)
- `proxies` — пул прокси-серверов с механизмом блокировки и подсчета ошибок
- `catalog_tasks` / `object_tasks` — очереди задач парсинга
- `catalog_listings` — объявления из каталогов с изображениями
- `object_data` — детальные данные объявлений (история замеров)
- `validation_results` — результаты трех этапов валидации
- `reparse_filter_*` — фильтры для повторного парсинга
- `analytics_*` — таблицы аналитики

---

### `create_db.py`
**Статус:** ВРЕМЕННЫЙ (для выполнения миграции)

Создает/обновляет структуру БД из `schema.sql`. Содержит встроенную миграцию для переименования `status → state` в таблице articulums.

**Когда запускать:** При первом развертывании или если миграция `status → state` ещё не выполнена.

**После выполнения миграции:** Этот скрипт можно удалить. Инициализация БД будет через `psql -f schema.sql`.

---

## Скрипты загрузки данных

### `load_articulums.py`
**Статус:** НЕОБХОДИМ | **Интерактивный режим:** ДА

Загружает артикулы из текстового файла в БД.

**Два режима работы:**

1. **Интерактивный режим** (запуск без аргументов):
   ```bash
   python load_articulums.py
   ```
   - Запрашивает путь к файлу
   - Показывает превью данных (первые 5 строк)
   - Интерактивный выбор режима (add/replace)
   - Подтверждение перед загрузкой

2. **CLI режим** (для автоматизации):
   ```bash
   python load_articulums.py --file data/articulums.txt --mode replace
   ```

**Параметры CLI:**
- `--file` — путь к файлу с артикулами (один артикул на строку)
- `--mode add|replace` — добавить к существующим или полная замена
- `--min-length N` — фильтр по минимальной длине артикула

---

### `load_proxies.py`
**Статус:** НЕОБХОДИМ | **Интерактивный режим:** ДА

Загружает прокси-серверы из текстового файла в БД.

**Формат файла:** `host:port:username:password` (по одному на строку)

**Два режима работы:**

1. **Интерактивный режим** (запуск без аргументов):
   ```bash
   python load_proxies.py
   ```
   - Запрашивает путь к файлу
   - Показывает превью данных (пароли скрыты)
   - Интерактивный выбор режима (add/replace)
   - Подтверждение перед загрузкой

2. **CLI режим** (для автоматизации):
   ```bash
   python load_proxies.py --file data/proxies.txt --mode add
   ```

---

### `load_filter_articulums.py`
**Статус:** ПОЛЕЗНЫЙ (для режима REPARSE) | **Интерактивный режим:** ДА

Загружает список артикулов для повторного парсинга в таблицу `reparse_filter_articulums`.

**Два режима работы:**

1. **Интерактивный режим:**
   ```bash
   python load_filter_articulums.py
   ```

2. **CLI режим:**
   ```bash
   python load_filter_articulums.py data/filter.txt --mode replace
   ```

**Особенность:** Проверяет существование артикулов в БД перед добавлением.

---

### `load_filter_items.py`
**Статус:** ПОЛЕЗНЫЙ (для режима REPARSE) | **Интерактивный режим:** ДА

Загружает список avito_item_id для повторного парсинга в таблицу `reparse_filter_items`.

**Два режима работы:**

1. **Интерактивный режим:**
   ```bash
   python load_filter_items.py
   ```

2. **CLI режим:**
   ```bash
   python load_filter_items.py data/items.txt --mode replace
   ```

---

### `reset_db.py`
**Статус:** ПОЛЕЗНЫЙ (для полного сброса)

Комбинированный скрипт: очищает все таблицы и заново загружает артикулы + прокси из файлов в `data/`. Удобен для полного перезапуска системы с нуля.

**Что делает:**
1. Очищает все таблицы (catalog_tasks, object_tasks, catalog_listings, articulums, proxies)
2. Загружает артикулы из `data/articulums.txt`
3. Загружает прокси из `data/proxies.txt`

---

### `clear_tables.py`
**Статус:** ПОЛЕЗНЫЙ (для выборочной очистки) | **Интерактивный режим:** ДА

Интерактивная очистка таблиц БД с тройным/двойным подтверждением.

**Режимы:**
- `--mode all` — очистить все служебные таблицы (кроме object_data и analytics_views)
- `--mode select` — интерактивный выбор таблиц
- `--mode reset-proxies` — освободить все прокси без удаления

**Пример:**
```bash
python clear_tables.py --mode reset-proxies  # Быстрый сброс прокси
python clear_tables.py --mode all --yes      # Полная очистка без подтверждения
python clear_tables.py --mode select         # Интерактивный выбор
```

---

## Миграции базы данных

### `migrate_add_images.py`
**Статус:** НЕОБХОДИМ (выполнена)

Добавляет колонки для хранения изображений в `catalog_listings`:
- `images_urls` (JSONB) — массив URL изображений
- `images_bytes` (BYTEA[]) — байты изображений
- `images_count` (SMALLINT) — количество изображений

Скрипт идемпотентен — можно запускать повторно безопасно.

---

### `migrate_proxy_errors.py`
**Статус:** НЕОБХОДИМ (выполнена)

Добавляет механизм отслеживания ошибок прокси:
- `consecutive_errors` (INTEGER) — счетчик последовательных ошибок
- `last_error_at` (TIMESTAMP) — время последней ошибки

Используется для автоматической блокировки проблемных прокси.

---

### `migrate_worker_id.py`
**Статус:** НЕОБХОДИМ (выполнена)

Меняет тип `worker_id` с INTEGER на VARCHAR(50) для поддержки multi-server развертывания. После миграции worker_id содержит строковые идентификаторы вида `server1_worker_3`.

---

### `add_seller_reviews_column.py`
**Статус:** НЕОБХОДИМ (выполнена)

Добавляет колонку `seller_reviews` в `catalog_listings` для хранения количества отзывов продавца.

---

## Аналитика и отчеты

### `dashboard.py`
**Статус:** ОЧЕНЬ ПОЛЕЗНЫЙ

Дашборд мониторинга системы в терминале. Показывает:
- Статистику задач парсинга (pending/processing/completed/failed)
- Состояние прокси (доступно/используется/заблокировано)
- Прогресс по артикулам (NEW/CATALOG_PARSING/VALIDATED и т.д.)
- Результаты валидации по этапам
- Количество активных воркеров
- Общую статистику парсинга

**Запуск:**
```bash
python dashboard.py
```

---

### `generate_analytics.py`
**Статус:** ПОЛЕЗНЫЙ

Генерирует аналитику по динамике просмотров объявлений. Рассчитывает:
- Изменение просмотров между замерами
- Коэффициент эффективности (просмотры/час)

Результаты сохраняются в таблицу `analytics_views`.

**Требует:** Минимум 2 замера для каждого объявления.

---

### `articulum_report.py`
**Статус:** ПОЛЕЗНЫЙ

Генерирует детальный отчет по валидации объявлений. Для каждого артикула показывает:
- Результаты каждого этапа валидации (price_filter, mechanical, ai)
- Причины отклонения
- Итоговый статус

Можно фильтровать по списку артикулов из `data/report_articulums.txt`.

---

### `compute_normal_min_prices.py`
**Статус:** СПЕЦИФИЧЕСКИЙ

Рассчитывает "нормальную" минимальную цену для артикулов, устойчивую к выбросам. Использует статистические методы (медиана, квартили, IQR) для отсечения аномально низких цен.

**Требует:** pandas, Excel-файл с колонками `articulum` и `min_price`

**Используется:** Для анализа подозрительно низких цен и выявления подделок.

---

## Экспорт данных

### `export_articulum_brands.py`
**Статус:** СПЕЦИФИЧЕСКИЙ

Экспортирует бренды и минимальные цены по артикулам в Excel. Содержит сложный алгоритм извлечения брендов из текстов объявлений:
- Парсит названия и описания
- Объединяет последовательности слов (для составных брендов типа "LAND ROVER")
- Фильтрует стоп-слова
- Учитывает транслитерацию кириллицы

**Требует:** pandas, openpyxl

---

### `export_validated_articulums.py`
**Статус:** СПЕЦИФИЧЕСКИЙ

Экспортирует список артикулов, прошедших валидацию, в текстовый файл. Выполняет полный цикл валидации (price_filter + mechanical) без AI и сохраняет артикулы с достаточным количеством валидных объявлений.

**Параметры внутри скрипта:**
- `MIN_PRICE = 8000` — минимальная цена
- `MIN_VALIDATED_ITEMS = 5` — минимум объявлений для прохождения

---

## Деплой

### `deploy.py`
**Статус:** НЕОБХОДИМ (для production)

Скрипт автоматического деплоя на несколько серверов через SSH.

**Что делает:**
1. Подключается к серверам по SSH
2. Проверяет/устанавливает Docker и Docker Compose
3. Останавливает контейнеры
4. Копирует файлы из `container/`
5. Создает `.env` файл с конфигурацией
6. Собирает и запускает контейнеры

**Конфигурация:** `data/servers.yaml`

**Параметры:**
- `--server NAME` — деплой только на указанный сервер
- `--dry-run` — показать конфиг без деплоя
- `--logs` — показать логи контейнеров

**Пример:**
```bash
python deploy.py --dry-run          # Проверить конфиг
python deploy.py                    # Деплой на все сервера
python deploy.py --server prod-1    # Деплой на конкретный сервер
python deploy.py --logs --lines 50  # Показать логи
```

---

## Папка data/

Содержит конфигурационные файлы:

| Файл | Назначение |
|------|------------|
| `articulums.txt` | Список артикулов для парсинга |
| `proxies.txt` | Список прокси (host:port:user:pass) |
| `servers.yaml` | Конфигурация серверов для деплоя |

---

## Рекомендации по необходимости скриптов

### ОБЯЗАТЕЛЬНЫЕ (ядро системы)
| Скрипт | Причина |
|--------|---------|
| `schema.sql` | Определение структуры БД |
| `load_articulums.py` | Загрузка данных для работы |
| `load_proxies.py` | Загрузка прокси для работы |
| `deploy.py` | Деплой на сервера |
| Все `migrate_*.py` | Миграции уже применены, нужны для истории |

### ПОЛЕЗНЫЕ (регулярное использование)
| Скрипт | Причина |
|--------|---------|
| `dashboard.py` | Мониторинг системы |
| `clear_tables.py` | Управление данными |
| `reset_db.py` | Быстрый сброс системы |
| `load_filter_*.py` | Для режима REPARSE |

### СПЕЦИФИЧЕСКИЕ (по необходимости)
| Скрипт | Когда нужен |
|--------|-------------|
| `generate_analytics.py` | Анализ динамики просмотров |
| `articulum_report.py` | Детальный анализ валидации |
| `export_*.py` | Экспорт данных для анализа |
| `compute_normal_min_prices.py` | Анализ ценовых аномалий |

### ВРЕМЕННЫЕ (можно удалить)
| Скрипт | Причина |
|--------|---------|
| `create_db.py` | После выполнения миграции `status → state` можно удалить |

---

## Порядок работы при первом запуске

1. Создать БД: `psql -f schema.sql` (или `python create_db.py` если миграция нужна)
2. Применить миграции (если не в schema.sql):
   - `python migrate_add_images.py`
   - `python migrate_proxy_errors.py`
   - `python migrate_worker_id.py`
   - `python add_seller_reviews_column.py`
3. Загрузить данные (интерактивный режим):
   - `python load_articulums.py`
   - `python load_proxies.py`
4. Настроить `data/servers.yaml`
5. Деплой: `python deploy.py`
6. Мониторинг: `python dashboard.py`

---

## Интерактивный режим скриптов загрузки

Все скрипты загрузки данных поддерживают два режима работы:

| Скрипт | Интерактивный режим | CLI режим |
|--------|---------------------|-----------|
| `load_articulums.py` | `python load_articulums.py` | `python load_articulums.py --file ... --mode ...` |
| `load_proxies.py` | `python load_proxies.py` | `python load_proxies.py --file ... --mode ...` |
| `load_filter_articulums.py` | `python load_filter_articulums.py` | `python load_filter_articulums.py file.txt --mode ...` |
| `load_filter_items.py` | `python load_filter_items.py` | `python load_filter_items.py file.txt --mode ...` |

**Интерактивный режим включает:**
- Запрос пути к файлу
- Превью данных (первые 5 строк)
- Выбор режима через меню (add/replace)
- Подтверждение перед выполнением
- Отчёт о результатах

**Все операции выполняются в транзакциях** — данные либо загружаются полностью, либо не загружаются вовсе.

---

*Документ обновлён: январь 2026*
