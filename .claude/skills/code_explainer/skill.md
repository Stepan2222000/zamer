---
name: code-explainer
description: >
  Глубокий анализ кодовой базы и объяснение пайплайна системы.
  Используй когда пользователь просит объяснить код, проанализировать архитектуру,
  понять как работает система, описать пайплайн, разобраться в кодовой базе.
  Триггеры: объясни код, как работает, проанализируй, опиши пайплайн,
  разбери архитектуру, explain code, analyze pipeline.
---

# Code Explainer

Создаёт полное объяснение пайплайна системы на русском языке с достаточной глубиной для понимания архитектуры и логики работы.

## Требования к полноте

**Объём:** Документ должен быть достаточно подробным, чтобы разработчик мог понять систему без постоянного обращения к коду. Для среднего проекта (10-20 файлов) — ориентировочно 300-800 строк.

**Что обязательно включать:**
- Все этапы пайплайна от запуска до завершения
- Все ключевые функции и методы каждого модуля
- Логику ветвления для критичных мест (обработка ошибок, состояния)
- Все состояния и переходы state machine (если есть)
- Взаимодействие между компонентами
- Обработку основных типов ошибок
- SQL-запросы для критичных операций

**Чего НЕ делать:**
- Не описывать каждый параметр каждой функции
- Не расписывать очевидную логику (геттеры, простые хелперы)
- Не дублировать одинаковую логику для похожих функций

## Процесс анализа

### 1. Получить scope анализа

Пользователь указывает папки/файлы для анализа. Если не указал — спросить.

### 2. Собрать структуру проекта

Получить список всех файлов в указанном scope.

### 3. Определить entry points

Искать точки входа в порядке приоритета:

**Оркестрация:**
- `docker-compose.yml`, `docker-compose.yaml`
- `Makefile`, `Dockerfile`

**Python:**
- `main.py`, `app.py`, `run.py`, `__main__.py`
- Файлы с `if __name__ == '__main__'`

**JavaScript/TypeScript:**
- `package.json` → поле `main` или `scripts.start`
- `index.js`, `index.ts`, `server.js`, `app.js`

**Go:**
- `main.go`, `cmd/*/main.go`

### 4. Полное чтение всех файлов

**Читать ВСЕ файлы** в указанном scope. Для каждого файла фиксировать:
- Назначение модуля
- Ключевые классы/функции и их роли
- Зависимости (импорты)
- Связь с другими модулями

### 5. Построить полный пайплайн

Проследить flow выполнения от entry point до конца:

**Для каждого этапа:**
- Что происходит и почему
- Какой код отвечает (файл:строка-строка)
- Все возможные ветки выполнения для критичных мест
- Как данные трансформируются
- Переход к следующему этапу

**Особое внимание:**
- Асинхронные операции
- Обработка ошибок и retry-логика
- State machine переходы
- Транзакции и атомарность

### 6. Создать документ

Сгенерировать Markdown документ согласно формату вывода.

## Формат вывода

### Структура документа

```markdown
# [Название системы] — Объяснение пайплайна

## Обзор системы

Описание:
- Что делает система
- Какие технологии использует
- Из каких компонентов состоит
- Как компоненты взаимодействуют

## Структура проекта

Дерево файлов с кратким описанием каждого файла.

## Конфигурация

Таблица основных параметров:
| Параметр | Описание | Default |
|----------|----------|---------|
| ... | ... | ... |

## Пайплайн

### Этап 1: [Название]

Подробное описание этапа с ссылками на код.

**Ключевые функции:**
- `function1()` (`файл.py:10-50`) — что делает
- `function2()` (`файл.py:52-80`) — что делает

**Обработка ошибок:**
- Ошибка X → действие Y
- Ошибка Z → действие W

**Переход к следующему этапу:**
Когда и как происходит.

### Этап 2: [Название]
... и так далее

## Описание модулей

### module1.py

**Назначение:** Что делает модуль

**Ключевые компоненты:**

#### class ClassName
Назначение класса.

**Основные методы:**
- `method1()` — что делает, когда вызывается
- `method2()` — что делает, какие имеет ветки

#### Функции модуля
- `func1()` — назначение и логика
- `func2()` — назначение и логика

### module2.py
... и так для каждого модуля

## State Machine (если есть)

Диаграмма состояний:
```
STATE1 → STATE2 → STATE3
              ↓
          STATE_ERROR
```

Описание каждого состояния и условий переходов.

## Обработка ошибок

Основные типы ошибок и их обработка:
- Сетевые ошибки — ...
- Ошибки БД — ...
- Бизнес-ошибки — ...

## Диаграмма потока данных

```
Компонент1 → Компонент2 → Компонент3
     ↓            ↓
   [БД]        [API]
```
```

## Правила оформления

**Ссылки на код:**
- Формат: `файл:строка-строка` относительно корня проекта
- Пример: `src/workers/parser.py:45-67`
- Указывать для ключевых блоков кода

**Код в документе:**
- Включать важные SQL-запросы
- Показывать примеры вызовов для сложной логики

**Стиль:**
- Писать как объяснение для разработчика
- Связывать этапы логически
- Объяснять ПОЧЕМУ так сделано

**Таблицы:**
- Для параметров конфигурации
- Для маппинга состояний
- Для описания статусов/кодов ошибок

## Чек-лист (проверить перед завершением)

- [ ] Описаны все этапы пайплайна от запуска до завершения
- [ ] Описаны все модули в scope
- [ ] Для каждого модуля перечислены ключевые функции/классы
- [ ] Описана логика ветвления для критичных мест
- [ ] Описаны все состояния state machine (если есть)
- [ ] Описана обработка основных ошибок
- [ ] Есть диаграмма потока данных
- [ ] Есть таблица конфигурации

## Важно

- **Результат:** Создать файл markdown с полным описанием
- **Язык:** Всегда русский
- **Глубина:** Достаточная для понимания без постоянного чтения кода
- **Формат ссылок:** `файл:строка-строка`
- **Фокус:** Объяснить КАК работает система, проследить весь flow
